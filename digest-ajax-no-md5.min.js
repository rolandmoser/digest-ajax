/*(c) 2014 Kynec Studios, Andrew Mitchell | MIT License opensource.org/licenses/MIT */
/* patched version available at https://github.com/rolandmoser/digest-ajax */
!function(e){DigestAjax=function(){},DigestAjax.authHelper=function(){return{username:"",password:""}},DigestAjax.UNAUTH_HA1=null,DigestAjax.AUTH_HA1=null,DigestAjax.UNAUTH_USERNAME=null,DigestAjax.AUTH_USERNAME=null,DigestAjax.WWW_AUTHENTICATE="WWW-Authenticate",DigestAjax.ajaxDigest=function(t,a,s,i){function n(){return e.ajax(p).done(function(e,t,a){f.resolve(e,t,a)}).fail(function(e,t,a){if(401===e.status||407===e.status){var s=A(e);null!==s?r(s):f.reject(e,t,a)}else f.reject(e,t,a)})}function r(t){return void 0===p.headers&&(p.headers={}),p.headers.Authorization=t,e.ajax(p).done(function(e,t,a){null!==DigestAjax.UNAUTH_HA1&&(DigestAjax.AUTH_HA1=DigestAjax.UNAUTH_HA1,DigestAjax.UNAUTH_HA1=null),null!==DigestAjax.UNAUTH_USERNAME&&(DigestAjax.AUTH_USERNAME=DigestAjax.UNAUTH_USERNAME,DigestAjax.UNAUTH_USERNAME=null),f.resolve(e,t,a)}).fail(function(e,t,a){(401===e.status||407===e.status)&&(DigestAjax.AUTH_HA1=null,DigestAjax.AUTH_USERNAME=null),f.reject(e,t,a)})}function u(e){for(var t={},a=e.getAllResponseHeaders(),s=a.split("\r\n"),i=0;i<s.length;i++){var n=s[i].split(": ",2),r=n[0];if(""!=r){var u="";2==n.length&&(u=n[1]),t[r.toLowerCase()]=u.split("\n")}}return t}function o(e,t){return headersDict=u(e),headersDict[t.toLowerCase()]}function A(t){var a=o(t,DigestAjax.WWW_AUTHENTICATE);if(void 0===a)return null;for(var s,i=0;i<a.length;i++){s=g(a[i]);var n=s.qop;if(void 0===n||"auth"===n||"auth-int"===n){var r=s.algorithm;if(void 0===r||"MD5"===r||"MD5-sess"===r)break}}if(i===a.length)return null;var n=s.qop,u=void 0;void 0!==n&&"auth-int"===n.toLowerCase()?u="auth-int":void 0!==n&&"auth"===n.toLowerCase()&&(u="auth");var A,D,j,r=s.algorithm;if(null!==DigestAjax.AUTH_HA1)A=DigestAjax.AUTH_HA1,D=DigestAjax.AUTH_USERNAME;else{if(null===p.username||null===p.password){var x=e.extend({username:"",password:""},DigestAjax.authHelper());e.extend(p,x)}A=CryptoJS.MD5(p.username+":"+s.realm+":"+p.password),D=p.username,DigestAjax.UNAUTH_HA1=A,DigestAjax.UNAUTH_USERNAME=p.username}void 0!==r&&"md5-sess"===r.toLowerCase()&&(j=l(),A=CryptoJS.MD5(A+":"+s.nonce+":"+j));var f,U;if("auth-int"===u){var c=p.data?p.data:"";f=CryptoJS.MD5(p.type+":"+p.requestUri+":"+CryptoJS.MD5(c))}else f=CryptoJS.MD5(p.type+":"+p.requestUri);var U,d;void 0===u?U=CryptoJS.MD5(A+":"+s.nonce+":"+f):(void 0===j&&(j=l()),d="00000001",U=CryptoJS.MD5(A+":"+s.nonce+":"+d+":"+j+":"+u+":"+f));var h=[];return h.push('Digest username="',D,'",'),h.push('realm="',s.realm,'",'),h.push('nonce="',s.nonce,'",'),h.push('uri="',p.requestUri,'",'),void 0!==u&&h.push("qop=",u,","),void 0!==r&&h.push('algorithm="',r,'",'),void 0!==d&&h.push("nc=",d,","),void 0!==j&&h.push('cnonce="',j,'",'),void 0!==s.opaque&&h.push('opaque="',s.opaque,'",'),h.push('response="',U,'"'),h.join("")}function g(e){var t={},a=/([^"',\s]*)="([^"]*)/gm,s=null;do s=a.exec(e),null!==s&&(t[s[1]]=s[2]);while(null!==s);return t}function l(){for(var e="abcdef0123456789",t="",a=0;8>a;a++){var s=Math.floor(Math.random()*e.length);t+=e.substr(s,1)}return t}var D,j,p={},x=document.createElement("a");"object"==typeof t?(p=t,x.href=p.url):"string"==typeof t&&("string"==typeof a?(D=a?a:null,j=s?s:null):"object"==typeof a&&(p=a?a:{},D=s?s:null,j=i?i:null),x.href=t,p.url=t),p=e.extend({requestUri:x.pathname+x.search,username:D,password:j,type:"GET"},p);var f=e.Deferred();return f.promise(n())},DigestAjax.ajaxDigestType=function(e,t,a,s,i){return"string"==typeof a&&(i=s,s=a),"object"!=typeof a&&(a={}),a.type=e,DigestAjax.ajaxDigest(t,a,s,i)},DigestAjax.getDigest=function(e,t,a,s){return DigestAjax.ajaxDigestType("GET",e,t,a,s)},DigestAjax.postDigest=function(e,t,a,s){return DigestAjax.ajaxDigestType("POST",e,t,a,s)},DigestAjax.putDigest=function(e,t,a,s){return DigestAjax.ajaxDigestType("PUT",e,t,a,s)},DigestAjax.deleteDigest=function(e,t,a,s){return DigestAjax.ajaxDigestType("DELETE",e,t,a,s)},e.extend({authHelper:function(e){DigestAjax.authHelper=e},ajaxDigest:DigestAjax.ajaxDigest,ajaxDigestType:DigestAjax.ajaxDigestType,getDigest:DigestAjax.getDigest,postDigest:DigestAjax.postDigest,putDigest:DigestAjax.putDigest,deleteDigest:DigestAjax.deleteDigest})}(jQuery);
